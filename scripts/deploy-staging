## Optimise
composer install --no-interaction

# Set timestamp
echo "Creating Time Stamp..."
TIMESTAMP=$(date +%Y%m%d%H%M%S)
echo $TIMESTAMP

# Make a new releases folder
echo "Creating release folder..."
ssh $USERNAME@$HOST "mkdir $STAGING_DEPLOY_TO/releases/$TIMESTAMP"

# Copy files
echo "Deploying files to production server..."
rsync -avz -e "ssh" --exclude-from="html/app/themes/creative-store/.exclude-deploy" --exclude="app/themes/creative-store/.exclude-deploy" ~/clone/html/ $USERNAME@$HOST:$STAGING_DEPLOY_TO/releases/$TIMESTAMP

# Symlink shared folders
echo "Symlinking shared folders..."
ssh $USERNAME@$HOST "ln -s $STAGING_SHARED/media $STAGING_DEPLOY_TO/releases/$TIMESTAMP/media"
ssh $USERNAME@$HOST "ln -s $STAGING_SHARED/languages $STAGING_DEPLOY_TO/releases/$TIMESTAMP/app/languages"

#ssh $USERNAME@$HOST "ln -s $STAGING_SHARED/logs $STAGING_DEPLOY_TO/releases/$TIMESTAMP/app/logs

# Update app version
echo "Updating app to new version..."
ssh $USERNAME@$HOST "rm -rf $STAGING_CURRENT;ln -s $STAGING_DEPLOY_TO/releases/$TIMESTAMP/ $STAGING_CURRENT"

# Cleanup
#ssh $USERNAME@$HOST "cd $STAGING_DEPLOY_TO/releases/;rm -rf `ls -t | tail -n +6`;ls -l"
